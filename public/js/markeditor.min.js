!function(e){var t=document.getElementById("input-title"),a=document.getElementById("editor"),c=e(a),s=document.getElementById("preview"),l=e(s);marked.setOptions({highlight:function(e){return hljs.highlightAuto(e).value}});var i,r=e(".undo"),n=e(".redo"),o=[],d=[],u=e(".show-double"),v=e(".show-editor"),f=e(".show-preview"),g=e(".toolbar"),b=e(".form-wrapper"),p=e(".article-list"),k=/(^\s*)|(\s*$)/g;articleSpare=JSON.stringify([{title:"文章1",body:"# 文章1",date:"2016-5-20 20:41:48"},{title:"文章2",body:"# 文章2",date:"2016-5-20 20:41:49"}]);var h=localStorage.getItem("article")||articleSpare,w=JSON.parse(h),m=w[w.length-1],y=new Date;m.date=y.getFullYear()+"-"+(y.getMonth()+1)+"-"+y.getDate()+" "+y.getHours()+":"+y.getMinutes()+":"+y.getSeconds(),t.value=m.title,a.value=m.body,s.innerHTML=marked(a.value);var E=function(){h=JSON.stringify(w),localStorage.setItem("article",h)};document.getElementById("main").style.height=document.body.clientHeight-60+"px",window.addEventListener("resize",function(){document.getElementById("main").style.height=document.body.clientHeight-60+"px"}),c.on("input propertychange",function(){s.innerHTML=marked(a.value),d=[],n.attr("disabled",!0).css("background-color","#555"),r.attr("disabled",!1).css("background-color","#fcfcfc")});var S=function(){var e;e=this===a?s:a,e.removeEventListener("scroll",S);var t=this.scrollTop/(this.scrollHeight-this.offsetHeight);e.scrollTop=t*(e.scrollHeight-e.offsetHeight),setTimeout(function(){e.addEventListener("scroll",S)},200)};a.addEventListener("scroll",S),s.addEventListener("scroll",S);var L=function(){o[o.length-1]!==a.value&&(o.length>50&&o.shift(),o.push(a.value),m.body=a.value,E()),i=setTimeout(L,800)};L(),a.addEventListener("keydown",function(e){var t=e.keyCode||e.which;if(9===t){var c=a.selectionStart,l=a.selectionEnd;a.value=a.value.substring(0,c)+"	"+a.value.substring(l),a.selectionStart=a.selectionEnd=c+1,e.preventDefault(),r.attr("disabled",!1).css("background-color","#fcfcfc"),s.innerHTML=marked(a.value)}}),document.addEventListener("drop",function(t){t.preventDefault(),t.stopPropagation();var c=new FileReader;c.onload=function(t){e(".new-article").click(),a.value=t.target.result,m.body=a.value,s.innerHTML=marked(a.value),E()},c.readAsText(t.dataTransfer.files[0])},!1),t.addEventListener("change",function(){m.title=t.value.replace(k,"").replace(/[<>'&]/g,function(e){switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&quot;"}}),m.title=m.title||m.date;var e=m.title;e=e.length<11?e:e.substring(0,10)+"...",p.find('li[alt="'+m.date+'"]').html(e+'<a class="delete" title="删除文章"></a>'),E()}),e(".nav").click(function(b){var k=e(b.target);switch(k.attr("class")){case"new-article":case"icon-new":clearTimeout(i),o=[],d=[],r.attr("disabled",!0).css("background-color","#555"),n.attr("disabled",!0).css("background-color","#555"),m={title:"新建文章",body:"",date:""},w.push(m);var h=new Date;m.date=h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate()+" "+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds(),t.value=m.title,a.value=m.body,s.innerHTML=marked(a.value),e(".active").removeClass("active"),p.prepend('<li class="active" alt="'+m.date+'" title="选择文章">'+m.title+'<a class="delete" title="删除文章"></a></li>'),L();break;case"del-article":case"icon-del":for(var y=(m.date,p.children().length),S=0;y>S;S++)e(p.children()[S]).is(".active")&&e(p.children()[S]).find(".delete").click();break;case"down-article":case"icon-download":var H=m.title+".md",M=new Blob([m.body],{type:"text/plain"});if(window.saveAs)window.saveAs(M,H);else if(navigator.saveBlob)navigator.saveBlob(M,H);else{url=URL.createObjectURL(M);var T=document.createElement("a");T.setAttribute("href",url),T.setAttribute("download",H);var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),T.dispatchEvent(b)}break;case"undo":case"icon-undo":o.length>1&&(d.push(o.pop()),c.val(o[o.length-1]).blur(),n.attr("disabled",!1).css("background-color","#fcfcfc"),s.innerHTML=marked(a.value),m.body=a.value,E(),o.length<=1&&r.attr("disabled",!0).css("background-color","#555"));break;case"redo":case"icon-redo":if(0!==d.length){var x=d.pop();o.push(x),r.attr("disabled",!1).css("background-color","#fcfcfc"),c.val(x).blur(),s.innerHTML=marked(a.value),m.body=a.value,E(),0===d.length&&n.attr("disabled",!0).css("background-color","#555")}break;case"show-double":case"icon-double":c.css({display:"block",width:"48%"}),l.css({display:"block",width:"52%"}),g.css("display","block"),u.attr("disabled",!0).css("background-color","#555"),v.attr("disabled",!1).css("background-color","#fcfcfc"),f.attr("disabled",!1).css("background-color","#fcfcfc");break;case"show-editor":case"icon-editor":c.css({display:"block",width:"100%"}),l.css({display:"none",width:"0%"}),g.css("display","block"),v.attr("disabled",!0).css("background-color","#555"),u.attr("disabled",!1).css("background-color","#fcfcfc"),f.attr("disabled",!1).css("background-color","#fcfcfc");break;case"show-preview":case"icon-preview":c.css({display:"none",width:"0%"}),l.css({display:"block",width:"100%"}),g.css("display","none"),f.attr("disabled",!0).css("background-color","#555"),v.attr("disabled",!1).css("background-color","#fcfcfc"),u.attr("disabled",!1).css("background-color","#fcfcfc");break;case"show-tips":case"icon-tips":"none"===e(".tips").css("display")?e(".tips").css("display","block"):e(".tips").css("display","none")}});var H=function(e){if(document.selection){var t=document.selection.createRange();t.text=e}else if("number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd){var c=a.selectionStart,l=a.selectionEnd,i=c,n=a.value;a.value=n.substring(0,c)+e+n.substring(l,n.length),i+=e.length,"## 请输入标题"===e?(a.selectionStart=i-5,a.selectionEnd=i):"**请输入文字**"===e?(a.selectionStart=i-7,a.selectionEnd=i-2):"*请输入文字*"===e?(a.selectionStart=i-6,a.selectionEnd=i-1):"	 请输入代码"===e?(a.selectionStart=i-5,a.selectionEnd=i):"* 请输入列表项"===e?(a.selectionStart=i-6,a.selectionEnd=i):"1. 请输入列表项"===e?(a.selectionStart=i-6,a.selectionEnd=i):"> 请输入引用"===e?(a.selectionStart=i-5,a.selectionEnd=i):a.selectionStart=a.selectionEnd=i}else a.value+=e;a.focus(),r.attr("disabled",!1).css("background-color","#fcfcfc"),s.innerHTML=marked(a.value)},M=function(t){b.css("display","block"),b.click(function(c){var l=e(c.target);if(l.is(".cancel"))e(".form-wrapper input").val(""),b.css("display","none"),b.off("click keydown"),c.preventDefault(),a.focus();else if(l.is(".submit")){var i=e(".input-word").val().replace(k,""),n=e(".input-address").val().replace(k,"");H("img"===t?"!["+i+"]("+n+")":"["+i+"]("+n+")"),e(".form-wrapper input").val(""),b.css("display","none"),b.off("click keydown"),r.attr("disabled",!1).css("background-color","#fcfcfc"),s.innerHTML=marked(a.value),c.preventDefault(),a.focus()}}),b.keydown(function(c){var l=c.keyCode||c.which;if(13===l){var i=e(".input-word").val().replace(k,""),r=e(".input-address").val().replace(k,"");H("img"===t?"!["+i+"]("+r+")":"["+i+"]("+r+")"),e(".form-wrapper input").val(""),b.css("display","none"),b.off("click keydown"),s.innerHTML=marked(a.value),c.preventDefault(),a.focus()}})};g.click(function(t){var a=e(t.target);switch(a.attr("class")){case"add-heading":case"icon-heading":H("## 请输入标题");break;case"add-strong":case"icon-strong":H("**请输入文字**");break;case"add-italic":case"icon-italic":H("*请输入文字*");break;case"add-code":case"icon-code":H("	 请输入代码");break;case"add-link":case"icon-link":M("link");break;case"add-img":case"icon-img":M("img");break;case"add-ul":case"icon-ul":H("* 请输入列表项");break;case"add-ol":case"icon-ol":H("1. 请输入列表项");break;case"add-quote":case"icon-quote":H("> 请输入引用");break;case"add-line":case"icon-line":H("----------")}}),function(){for(var t=w.length-1;t>=0;t--){var a=w[t],c=a.title;c=c.length<11?c:c.substring(0,10)+"...",p.append('<li alt="'+a.date+'" title="选择文章">'+c+'<a class="delete" title="删除文章"></a></li>')}e(".article-list li:first-child").addClass("active")}(),e("#show-article").click(function(){"0px"===e(".aside").css("left")?(e(".icon-arrow_left").removeClass("icon-arrow_left").addClass("icon-arrow_right"),e(".aside").css("left","-250px"),e("#show-article").css("left","0px"),e(".modal").css("display","none"),e(".wrapper").css("left","0px"),L()):(e(".icon-arrow_right").removeClass("icon-arrow_right").addClass("icon-arrow_left"),e(".aside").css("left","0px"),e("#show-article").css("left","250px"),e(".modal").css("display","block"),e(".wrapper").css("left","250px"),clearTimeout(i))}),p.click(function(c){var l=e(c.target);if(l.is(".delete")){if(confirm("确定要删除此文章吗?")){var i=l.parent("li");i.is(".active")&&(i.next().is("li")?i.next().click():i.prev().is("li")?i.prev().click():e(".new-article").click());var u=i.attr("alt");i.remove();for(var v=0;v<w.length;v++)if(w[v].date===u){w.splice(v,1);break}}}else if(l.is("li")&&!l.is(".active")){o=[],d=[],r.attr("disabled",!0).css("background-color","#555"),n.attr("disabled",!0).css("background-color","#555");var u=l.attr("alt");e(".active").removeClass("active"),l.addClass("active");for(var v=0;v<w.length;v++)if(w[v].date===u){m=w[v],w.push(w[v]),w.splice(v,1);var f=new Date;m.date=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds(),l.attr("alt",m.date),t.value=m.title,a.value=m.body,s.innerHTML=marked(a.value);break}}E()})}(jQuery);