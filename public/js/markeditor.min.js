!function(e){var t=document.getElementById("input-title"),a=document.getElementById("editor"),s=e(a),c=document.getElementById("preview"),r=e(c);marked.setOptions({highlight:function(e){return hljs.highlightAuto(e).value}});var i,l=e(".undo"),n=e(".redo"),o=[],d=[],u=e(".show-double"),b=e(".show-editor"),f=e(".show-preview"),v=e(".toolbar"),g=e(".form-wrapper"),k=e(".article-list"),p=/(^\s*)|(\s*$)/g;articleSpare=JSON.stringify([{title:"文章1",body:"# 文章1",date:"2016-5-20 20:41:48"},{title:"文章2",body:"# 文章2",date:"2016-5-20 20:41:49"}]);var h=localStorage.getItem("article")||articleSpare,w=JSON.parse(h),m=w[w.length-1],y=new Date;m.date=y.getFullYear()+"-"+(y.getMonth()+1)+"-"+y.getDate()+" "+y.getHours()+":"+y.getMinutes()+":"+y.getSeconds(),t.value=m.title,a.value=m.body,c.innerHTML=marked(a.value);var x=function(){h=JSON.stringify(w),localStorage.setItem("article",h)};document.getElementById("main").style.height=document.body.clientHeight-60+"px",window.addEventListener("resize",function(){document.getElementById("main").style.height=document.body.clientHeight-60+"px"}),s.on("input propertychange",function(){c.innerHTML=marked(a.value),d=[],n.attr("disabled",!0).css("background-color","#555"),l.attr("disabled",!1).css("background-color","#fcfcfc")});var E=function(){var e;e=this===a?c:a,e.removeEventListener("scroll",E);var t=this.scrollTop/(this.scrollHeight-this.offsetHeight);e.scrollTop=t*(e.scrollHeight-e.offsetHeight),setTimeout(function(){e.addEventListener("scroll",E)},200)};a.addEventListener("scroll",E),c.addEventListener("scroll",E);var S=function(){o[o.length-1]!==a.value&&(o.length>50&&o.shift(),o.push(a.value),m.body=a.value,x()),i=setTimeout(S,800)};S(),a.addEventListener("keydown",function(e){var t=e.keyCode||e.which;if(9===t){var s=a.selectionStart,r=a.selectionEnd;a.value=a.value.substring(0,s)+"	"+a.value.substring(r),a.selectionStart=a.selectionEnd=s+1,e.preventDefault(),l.attr("disabled",!1).css("background-color","#fcfcfc"),c.innerHTML=marked(a.value)}}),document.addEventListener("drop",function(t){t.preventDefault(),t.stopPropagation();var s=new FileReader;s.onload=function(t){e(".new-article").click(),a.value=t.target.result,m.body=a.value,c.innerHTML=marked(a.value),x()},s.readAsText(t.dataTransfer.files[0])},!1),t.addEventListener("input",function(){m.title=t.value.replace(p,"").replace(/[<>'&]/g,function(e){switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&quot;"}}),m.title=m.title||m.date;var e=m.title;e=e.length<11?e:e.substring(0,10)+"...",k.find('li[alt="'+m.date+'"]').html(e+'<a class="delete" title="删除文章"></a>'),x()}),e(".nav").click(function(g){var p=e(g.target);switch(p.attr("class")){case"new-article":case"icon-new":clearTimeout(i),o=[],d=[],l.attr("disabled",!0).css("background-color","#555"),n.attr("disabled",!0).css("background-color","#555"),m={title:"新建文章",body:"",date:""},w.push(m);var h=new Date;m.date=h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate()+" "+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds(),t.value=m.title,a.value=m.body,c.innerHTML=marked(a.value),e(".active").removeClass("active"),k.prepend('<li class="active" alt="'+m.date+'" title="选择文章">'+m.title+'<a class="delete" title="删除文章"></a></li>'),S();break;case"del-article":case"icon-del":for(var y=(m.date,k.children().length),E=0;y>E;E++)e(k.children()[E]).is(".active")&&e(k.children()[E]).find(".delete").click();break;case"down-article":case"icon-download":var L=m.title+".md",H=new Blob([m.body],{type:"text/plain"});if(window.saveAs)window.saveAs(H,L);else if(navigator.saveBlob)navigator.saveBlob(H,L);else{url=URL.createObjectURL(H);var M=document.createElement("a");M.setAttribute("href",url),M.setAttribute("download",L);var g=document.createEvent("MouseEvents");g.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),M.dispatchEvent(g)}break;case"undo":case"icon-undo":o.length>1&&(d.push(o.pop()),s.val(o[o.length-1]).blur(),n.attr("disabled",!1).css("background-color","#fcfcfc"),c.innerHTML=marked(a.value),m.body=a.value,x(),o.length<=1&&l.attr("disabled",!0).css("background-color","#555"));break;case"redo":case"icon-redo":if(0!==d.length){var T=d.pop();o.push(T),l.attr("disabled",!1).css("background-color","#fcfcfc"),s.val(T).blur(),c.innerHTML=marked(a.value),m.body=a.value,x(),0===d.length&&n.attr("disabled",!0).css("background-color","#555")}break;case"show-double":case"icon-double":s.css({display:"block",width:"48%"}),r.css({display:"block",width:"52%"}),v.css("display","block"),u.attr("disabled",!0).css("background-color","#555"),b.attr("disabled",!1).css("background-color","#fcfcfc"),f.attr("disabled",!1).css("background-color","#fcfcfc");break;case"show-editor":case"icon-editor":s.css({display:"block",width:"100%"}),r.css({display:"none",width:"0%"}),v.css("display","block"),b.attr("disabled",!0).css("background-color","#555"),u.attr("disabled",!1).css("background-color","#fcfcfc"),f.attr("disabled",!1).css("background-color","#fcfcfc");break;case"show-preview":case"icon-preview":s.css({display:"none",width:"0%"}),r.css({display:"block",width:"100%"}),v.css("display","none"),f.attr("disabled",!0).css("background-color","#555"),b.attr("disabled",!1).css("background-color","#fcfcfc"),u.attr("disabled",!1).css("background-color","#fcfcfc");break;case"show-tips":case"icon-tips":"none"===e(".tips").css("display")?e(".tips").css("display","block"):e(".tips").css("display","none")}});var L=function(e){if(document.selection){var t=document.selection.createRange();if(""===t.text)t.text=e;else switch(e){case"## 请输入标题":t.text="## "+t.text;break;case"**请输入文字**":t.text="**"+t.text+"**";break;case"*请输入文字*":t.text="*"+t.text+"*";break;case"	 请输入代码":t.text="	 "+t.text;break;case"* 请输入列表项":t.text="* "+t.text;break;case"1. 请输入列表项":t.text="1. "+t.text;break;case"> 请输入引用":t.text="> "+t.text;break;default:t.text="-------"}}else if("number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd){var s=a.selectionStart,r=a.selectionEnd,i=s,n=a.value;if(s===r)switch(a.value=n.substring(0,s)+e+n.substring(r,n.length),i+=e.length,e){case"## 请输入标题":a.selectionStart=i-5,a.selectionEnd=i;break;case"**请输入文字**":a.selectionStart=i-7,a.selectionEnd=i-2;break;case"*请输入文字*":a.selectionStart=i-6,a.selectionEnd=i-1;break;case"	 请输入代码":a.selectionStart=i-5,a.selectionEnd=i;break;case"* 请输入列表项":a.selectionStart=i-6,a.selectionEnd=i;break;case"1. 请输入列表项":a.selectionStart=i-6,a.selectionEnd=i;break;case"> 请输入引用":a.selectionStart=i-5,a.selectionEnd=i;break;default:a.selectionStart=a.selectionEnd=i}else{var o;switch(e){case"## 请输入标题":o="## "+n.substring(s,r);break;case"**请输入文字**":o="**"+n.substring(s,r)+"**";break;case"*请输入文字*":o="*"+n.substring(s,r)+"*";break;case"	 请输入代码":o="	 "+n.substring(s,r);break;case"* 请输入列表项":o="* "+n.substring(s,r);break;case"1. 请输入列表项":o="1. "+n.substring(s,r);break;case"> 请输入引用":o="> "+n.substring(s,r);break;default:o="-------"}a.value=n.substring(0,s)+o+n.substring(r,n.length)}}else a.value+=e;a.focus(),l.attr("disabled",!1).css("background-color","#fcfcfc"),c.innerHTML=marked(a.value)},H=function(t){g.css("display","block"),g.click(function(s){var r=e(s.target);if(r.is(".cancel"))e(".form-wrapper input").val(""),g.css("display","none"),g.off("click keydown"),s.preventDefault(),a.focus();else if(r.is(".submit")){var i=e(".input-word").val().replace(p,""),n=e(".input-address").val().replace(p,"");L("img"===t?"!["+i+"]("+n+")":"["+i+"]("+n+")"),e(".form-wrapper input").val(""),g.css("display","none"),g.off("click keydown"),l.attr("disabled",!1).css("background-color","#fcfcfc"),c.innerHTML=marked(a.value),s.preventDefault(),a.focus()}}),g.keydown(function(s){var r=s.keyCode||s.which;if(13===r){var i=e(".input-word").val().replace(p,""),l=e(".input-address").val().replace(p,"");L("img"===t?"!["+i+"]("+l+")":"["+i+"]("+l+")"),e(".form-wrapper input").val(""),g.css("display","none"),g.off("click keydown"),c.innerHTML=marked(a.value),s.preventDefault(),a.focus()}})};v.click(function(t){var a=e(t.target);switch(a.attr("class")){case"add-heading":case"icon-heading":L("## 请输入标题");break;case"add-strong":case"icon-strong":L("**请输入文字**");break;case"add-italic":case"icon-italic":L("*请输入文字*");break;case"add-code":case"icon-code":L("	 请输入代码");break;case"add-link":case"icon-link":H("link");break;case"add-img":case"icon-img":H("img");break;case"add-ul":case"icon-ul":L("* 请输入列表项");break;case"add-ol":case"icon-ol":L("1. 请输入列表项");break;case"add-quote":case"icon-quote":L("> 请输入引用");break;case"add-line":case"icon-line":L("----------")}}),function(){for(var t=w.length-1;t>=0;t--){var a=w[t],s=a.title;s=s.length<11?s:s.substring(0,10)+"...",k.append('<li alt="'+a.date+'" title="选择文章">'+s+'<a class="delete" title="删除文章"></a></li>')}e(".article-list li:first-child").addClass("active")}(),e("#show-article").click(function(){"0px"===e(".aside").css("left")?(e(".icon-arrow_left").removeClass("icon-arrow_left").addClass("icon-arrow_right"),e(".aside").css("left","-250px"),e("#show-article").css("left","0px"),e(".modal").css("display","none"),e(".wrapper").css("left","0px"),S()):(e(".icon-arrow_right").removeClass("icon-arrow_right").addClass("icon-arrow_left"),e(".aside").css("left","0px"),e("#show-article").css("left","250px"),e(".modal").css("display","block"),e(".wrapper").css("left","250px"),clearTimeout(i))}),k.click(function(s){var r=e(s.target);if(r.is(".delete")){if(confirm("确定要删除此文章吗?")){var i=r.parent("li");i.is(".active")&&(i.next().is("li")?i.next().click():i.prev().is("li")?i.prev().click():e(".new-article").click());var u=i.attr("alt");i.remove();for(var b=0;b<w.length;b++)if(w[b].date===u){w.splice(b,1);break}}}else if(r.is("li")&&!r.is(".active")){o=[],d=[],l.attr("disabled",!0).css("background-color","#555"),n.attr("disabled",!0).css("background-color","#555");var u=r.attr("alt");e(".active").removeClass("active"),r.addClass("active");for(var b=0;b<w.length;b++)if(w[b].date===u){m=w[b],w.push(w[b]),w.splice(b,1);var f=new Date;m.date=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds(),r.attr("alt",m.date),t.value=m.title,a.value=m.body,c.innerHTML=marked(a.value);break}}x()})}(jQuery);